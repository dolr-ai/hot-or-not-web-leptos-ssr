name: Temporary Server Setup

on:
  workflow_dispatch:
  push:
    branches:
      - joel/bare-metal-migr
    paths:
      - '.github/workflows/server-setup-temp.yml'

jobs:
  setup-server:
    name: Setup Server 136.243.176.62
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HETZNER_BARE_METAL_GITHUB_ACTIONS_SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H 136.243.176.62 >> ~/.ssh/known_hosts

      - name: Check server connectivity
        run: |
          ssh -o ConnectTimeout=10 root@136.243.176.62 "echo 'Server connection successful'"

      - name: Diagnose and cleanup drives
        run: |
          ssh root@136.243.176.62 "
            echo '=== Current disk state ==='
            lsblk -f
            echo ''
            echo '=== Mounts ==='
            mount | grep nvme || echo 'No nvme mounts'
            echo ''
            echo '=== Processes using nvme drives ==='
            fuser -vm /dev/nvme0n1* 2>/dev/null || echo 'None on nvme0n1'
            fuser -vm /dev/nvme1n1* 2>/dev/null || echo 'None on nvme1n1'
            echo ''
            echo '=== Stopping Docker if running ==='
            systemctl stop docker 2>/dev/null || true
            systemctl stop containerd 2>/dev/null || true
            echo ''
            echo '=== Unmounting everything ==='
            umount -f /var/lib/docker 2>/dev/null || true
            umount -f /dev/nvme0n1p1 2>/dev/null || true
            umount -f /dev/nvme1n1p1 2>/dev/null || true
            umount -l /var/lib/docker 2>/dev/null || true
            echo ''
            echo '=== Remove fstab entries ==='
            sed -i '/nvme0n1/d' /etc/fstab
            sed -i '/nvme1n1/d' /etc/fstab
            echo ''
            echo '=== Kill any remaining processes ==='
            fuser -km /dev/nvme1n1 2>/dev/null || true
            fuser -km /dev/nvme1n1p1 2>/dev/null || true
            echo ''
            echo '=== Delete partitions ==='
            wipefs -a /dev/nvme1n1p1 2>/dev/null || true
            parted -s /dev/nvme1n1 rm 1 2>/dev/null || true
            echo ''
            sync
            sleep 3
            echo '=== Final state ==='
            lsblk -f
          "

      - name: Setup btrfs on NVMe drive
        run: |
          ssh root@136.243.176.62 "
            set -e
            echo '=== Setting up btrfs on /dev/nvme1n1 ==='

            # Wipe the drive
            wipefs -a /dev/nvme1n1

            # Create GPT partition table
            parted /dev/nvme1n1 mklabel gpt

            # Add NVMe to existing root btrfs filesystem
            btrfs device add -f /dev/nvme1n1 /

            echo 'Device added, showing filesystem:'
            btrfs filesystem show

            # Balance the filesystem across both devices
            echo 'Starting balance (this may take a while)...'
            btrfs balance start / --full-balance

            echo 'Balance complete, final status:'
            btrfs filesystem show
            df -h /
            btrfs filesystem usage /
            lsblk -f
          "

      - name: Install Docker
        run: |
          ssh root@136.243.176.62 "
            set -e
            echo '=== Installing Docker ==='

            # Install prerequisites
            apt-get update
            apt-get install -y ca-certificates curl gnupg

            # Add Docker's official GPG key
            install -m 0755 -d /etc/apt/keyrings
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
            chmod a+r /etc/apt/keyrings/docker.gpg

            # Add the repository to Apt sources
            echo \"deb [arch=\$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \$(. /etc/os-release && echo \$VERSION_CODENAME) stable\" | tee /etc/apt/sources.list.d/docker.list > /dev/null

            # Install Docker
            apt-get update
            apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

            # Enable and start Docker
            systemctl enable docker
            systemctl start docker

            echo 'Docker installation complete'
            docker --version
            docker compose version
          "

      - name: Configure unattended-upgrades
        run: |
          ssh root@136.243.176.62 'set -e && echo "=== Configuring unattended-upgrades ===" && apt-get install -y unattended-upgrades apt-listchanges && echo "APT::Periodic::Update-Package-Lists \"1\";" > /etc/apt/apt.conf.d/20auto-upgrades && echo "APT::Periodic::Unattended-Upgrade \"1\";" >> /etc/apt/apt.conf.d/20auto-upgrades && echo "APT::Periodic::AutocleanInterval \"7\";" >> /etc/apt/apt.conf.d/20auto-upgrades && systemctl enable unattended-upgrades && systemctl start unattended-upgrades && echo "Unattended-upgrades configuration complete"'

      - name: Create yral-frontend directory
        run: |
          ssh root@136.243.176.62 "
            mkdir -p /home/yral-frontend
            echo 'Created /home/yral-frontend directory'
          "

      - name: Final verification
        run: |
          ssh root@136.243.176.62 "
            echo '=== Final Verification ==='
            echo ''
            echo 'Disk status:'
            df -h /var/lib/docker
            echo ''
            echo 'Docker status:'
            docker --version
            systemctl is-active docker
            echo ''
            echo 'Unattended-upgrades status:'
            systemctl is-active unattended-upgrades
            echo ''
            echo 'Setup complete!'
          "
