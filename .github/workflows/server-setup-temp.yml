name: Temporary Server Setup

on:
  workflow_dispatch:
  push:
    branches:
      - joel/bare-metal-migr
    paths:
      - '.github/workflows/server-setup-temp.yml'

jobs:
  setup-server:
    name: Setup Server 136.243.176.62
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HETZNER_BARE_METAL_GITHUB_ACTIONS_SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H 136.243.176.62 >> ~/.ssh/known_hosts

      - name: Reboot server
        run: |
          ssh root@136.243.176.62 "reboot" || true
          echo "Reboot command sent, waiting for server to come back..."

      - name: Wait for server to come back
        run: |
          echo "Waiting 60 seconds for reboot..."
          sleep 60

          echo "Checking if server is back..."
          for i in {1..30}; do
            if ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no root@136.243.176.62 "echo 'Server is back'" 2>/dev/null; then
              echo "Server is online!"
              break
            fi
            echo "Attempt $i: Server not ready, waiting 10 seconds..."
            sleep 10
          done

      - name: Check Docker status
        run: |
          ssh root@136.243.176.62 "
            echo '=== Docker Status ==='
            systemctl status docker || echo 'Docker not running'
            echo ''
            echo '=== Docker Version ==='
            docker --version || echo 'Docker not installed'
            echo ''
            echo '=== Docker Compose Version ==='
            docker compose version || echo 'Docker compose not available'
            echo ''
            echo '=== Disk Status ==='
            df -h /
            echo ''
            echo '=== Btrfs Filesystem ==='
            btrfs filesystem show
            echo ''
            echo '=== Block Devices ==='
            lsblk -f
          "
