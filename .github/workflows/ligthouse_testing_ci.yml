name: Generate lighthouse test report on PR
on:
    pull_request:
        branches: [ main, lighthouse_testing_pipeline ]
        
jobs:
    lhci:
        runs-on: ubuntu-latest

        steps:
          - name: Checkout repo
            uses: actions/checkout@v3

          - name: Install Node.js
            uses: actions/setup-node@v4
            with: 
                node-version: 20
          - run: npm install

          # - uses: actions/checkout@master
          # - name: Lighthouse
          #   uses: foo-software/lighthouse-check-action@master
          #   with:
          #     urls: 'https://yral.com/'
    
          - name: Install Lighthouse
            run: npm install -g @lhci/cli@0.13.x

          - name: Run Lighthouse
            id: lhcitests
            run: lhci autorun --upload.githubToken="$LHCI_GITHUB_TOKEN" || echo "LHCI failed!"
            env: 
                LHCI_GITHUB_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

          # - name: install playwright
          #   run: npx playwright install    

          # - name: run playwright
          #   id: tests
          #   run: npx playwright test --project=firefox 
          #   continue-on-error: true
        
          # - name: Notify on Google Chat 
          #   uses: Co-qn/google-chat-notification@v1
          #   with:
          #     name: test
          #     url: ${{ secrets.TEST_WEBHOOK_URL }}
          #     status: ${{ steps.tests.outcome }}


          - name: Check test result and comment
            uses: peter-evans/create-or-update-comment@v1
            with:
              token: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
              issue-number: ${{ github.event.pull_request.number }}
              body: |
                ${{ steps.lhcitests.outputs }}
                    

          # - name: Trigger a workflow in another repo
          #   uses: actions/github-script@v5
          #   with:
          #       script: |
          #         github.rest.repos.createDispatchEvent({
          #           owner: 'shreybaz',
          #           repo: 'test_automation',
          #           event_type: 'call',
          #           client_payload: { key: "value" }
          #         });
          #       github-token: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
