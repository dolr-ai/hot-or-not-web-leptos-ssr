name: Build and Check linting for prod release

on:
  workflow_call:
    inputs:
      publish-artifact:
        default: false
        required: false
        type: boolean
  workflow_dispatch:

jobs:
  build_check:
    runs-on: self-hosted
    steps:
      - name: Checkout repo and submodules
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Build and check in devcontainer
        uses: devcontainers/ci@v0.3
        with:
          imageName: ghcr.io/${{ github.repository }}-devcontainer
          push: never
          runCmd: |
            # Install Rust nightly with required targets
            rustup install nightly-2025-06-15
            rustup default nightly-2025-06-15
            rustup target add x86_64-unknown-linux-musl wasm32-unknown-unknown
            rustup component add clippy rustfmt

            # Install cargo-leptos
            cargo binstall --no-confirm cargo-leptos --version 0.2.40 --locked --force

            # Install npm deps
            pnpm install

            # Lint check
            echo "Running lint checks..."
            cargo fmt --check
            cargo clippy --no-deps --all-features --release -- -Dwarnings

            # Print versions
            rustc --version
            cargo --version

            # Build
            echo "Building Leptos project..."
            LEPTOS_BIN_TARGET_TRIPLE=x86_64-unknown-linux-musl \
            LEPTOS_HASH_FILES=true \
            LEPTOS_TAILWIND_VERSION=v4.1.7 \
            cargo leptos build --release --lib-features release-lib --bin-features release-bin

            # Create empty file for artifact (ensures upload works even if hash.txt missing)
            touch .empty

      - name: Setup Sentry CLI
        uses: matbour/setup-sentry-cli@v2
        if: ${{ inputs.publish-artifact }}
        with:
          url: https://apm.yral.com
          token: ${{ secrets.SENTRY_AUTH_TOKEN }}
          organization: sentry
          project: leptos-ssr-server

      - name: Upload sentry Rust source context
        if: ${{ inputs.publish-artifact }}
        run: |
          objcopy --only-keep-debug target/x86_64-unknown-linux-musl/prod-release/hot-or-not-web-leptos-ssr{,.d}
          objcopy --strip-debug --strip-unneeded target/x86_64-unknown-linux-musl/prod-release/hot-or-not-web-leptos-ssr
          objcopy --add-gnu-debuglink target/x86_64-unknown-linux-musl/prod-release/hot-or-not-web-leptos-ssr{.d,}
          sentry-cli debug-files upload --org sentry --project leptos-ssr-server --auth-token $SENTRY_AUTH_TOKEN --include-sources .
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        continue-on-error: true

      - name: Archive production artifacts
        uses: actions/upload-artifact@v4
        if: ${{ inputs.publish-artifact }}
        with:
          name: build-musl
          path: |
            target/x86_64-unknown-linux-musl/prod-release/hot-or-not-web-leptos-ssr
            target/x86_64-unknown-linux-musl/prod-release/hash.txt
            target/site
            .empty

      - name: Find and display hash file
        run: |
          find . -name "hash.txt" -type f
